/*
 * Leaflet.gl ©2015 Iván Sánchez Ortega
 *
 * "THE BEER-WARE LICENSE":
 * <ivan@sanchezortega.es> wrote this file. As long as you retain this notice you
 * can do whatever you want with this stuff. If we meet some day, and you think
 * this stuff is worth it, you can buy me a beer in return.
 *
 *
 * Leaflet.gl includes unitbezier (https://github.com/mapbox/unitbezier),
 * distributed under a 2-clause BSD license.
 */

L.Browser.gl=!1;try{var canvas=document.createElement("canvas"),context=canvas.getContext("webgl");context&&"function"==typeof context.getParameter?L.Browser.gl="webgl":(context=canvas.getContext("experimental-webgl"),context&&"function"==typeof context.getParameter&&(L.Browser.gl="experimental-webgl"))}catch(e){}L.Browser.gl&&(L.GlUtil={createProgram:function(t,e,i,r,n){var o=t,a=o.createProgram(),s=o.createShader(o.VERTEX_SHADER),l=o.createShader(o.FRAGMENT_SHADER);if(o.shaderSource(s,e),o.shaderSource(l,i),o.compileShader(s),o.compileShader(l),!o.getShaderParameter(s,o.COMPILE_STATUS))throw new Error(o.getShaderInfoLog(s));if(!o.getShaderParameter(l,o.COMPILE_STATUS))throw new Error(o.getShaderInfoLog(l));o.attachShader(a,s),o.attachShader(a,l),o.linkProgram(a),a.attributes={},a.uniforms={};var h,u,m;if(r&&r.length)for(h=0;h<r.length;h++){if(m=r[h],u=o.getAttribLocation(a,m),-1===u)throw new Error("Attribute "+m+" not found in shaders");a.attributes[m]=u}if(n&&n.length)for(h=0;h<n.length;h++){if(m=n[h],u=o.getUniformLocation(a,m),-1===u)throw new Error("Uniform "+m+" not found in shaders");a.uniforms[m]=u}return a},initBuffer:function(t,e,i){var r=t,n=r.createBuffer();return r.bindBuffer(r.ARRAY_BUFFER,n),r.bufferData(r.ARRAY_BUFFER,e,i||r.STATIC_DRAW),n},initTexture:function(t,e){var i=t,r=i.createTexture();return i.bindTexture(i.TEXTURE_2D,r),i.texImage2D(i.TEXTURE_2D,0,i.RGBA,i.RGBA,i.UNSIGNED_BYTE,e),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_S,i.CLAMP_TO_EDGE),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_T,i.CLAMP_TO_EDGE),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MAG_FILTER,i.LINEAR),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MIN_FILTER,i.LINEAR),i.generateMipmap(i.TEXTURE_2D),i.bindTexture(i.TEXTURE_2D,null),r},bindBufferToAttrib:function(t,e,i,r,n){t.bindBuffer(t.ARRAY_BUFFER,e),t.vertexAttribPointer(i,r,n,!1,0,0)}},L.glUtil={},L.GlUtil.UnitBezier=function(t,e,i,r){this.cx=3*t,this.bx=3*(i-t)-this.cx,this.ax=1-this.cx-this.bx,this.cy=3*e,this.by=3*(r-e)-this.cy,this.ay=1-this.cy-this.by,this.p1x=t,this.p1y=r,this.p2x=i,this.p2y=r},L.GlUtil.UnitBezier.prototype={sampleCurveX:function(t){return((this.ax*t+this.bx)*t+this.cx)*t},sampleCurveY:function(t){return((this.ay*t+this.by)*t+this.cy)*t},sampleCurveDerivativeX:function(t){return(3*this.ax*t+2*this.bx)*t+this.cx},solveCurveX:function(t,e){"undefined"==typeof e&&(e=1e-6);var i,r,n,o,a;for(n=t,a=0;8>a;a++){if(o=this.sampleCurveX(n)-t,Math.abs(o)<e)return n;var s=this.sampleCurveDerivativeX(n);if(Math.abs(s)<1e-6)break;n-=o/s}if(i=0,r=1,n=t,i>n)return i;if(n>r)return r;for(;r>i;){if(o=this.sampleCurveX(n),Math.abs(o-t)<e)return n;t>o?i=n:r=n,n=.5*(r-i)+i}return n},solve:function(t,e){return this.sampleCurveY(this.solveCurveX(t,e))}},L.glUtil.unitBezier=function(t,e,i,r){return new L.GlUtil.UnitBezier(t,e,i,r)},function(){var t=L.extend({},L.Map.prototype);L.Map.include({_initLayout:function(){t._initLayout.call(this),this.on("move moveend",function(){this._glView.center=this.options.crs.project(this.getCenter());var t=this.options.crs.project(this.containerPointToLatLng(this.getSize()));this._glView.halfSize=t.subtract(this._glView.center),this.glRenderOnce()},this)}})}(),function(){var t=L.extend({},L.Map.prototype);L.Map.include({_initLayout:function(){t._initLayout.call(this),this.on("zoomanim",this._onGlZoomAnimationStart,this),this.on("zoomend",this._onGlZoomAnimationEnd,this)},_glZoomAnimationDuration:250,_onGlZoomAnimationStart:function(t){var e=this.options.crs.project(this.getCenter()),i=this.options.crs.project(this.containerPointToLatLng(this.getSize())),r=i.subtract(e),n=this.options.crs.project(this._animateToCenter),o=r.divideBy(this.getZoomScale(this._animateToZoom,this._zoom)),a=e.x,s=e.y,l=n.x,h=n.y,u=r.x,m=r.y,f=o.x,g=o.y,c=(l*u-a*f)/(u-f),_=(h*m-s*g)/(m-g),d=new L.Point(c,_),p=this.latLngToContainerPoint(this.options.crs.unproject(d)),v=this.getSize(),T=new L.Point(p.x/v.x,p.y/v.y).subtract(new L.Point(.5,.5)).multiplyBy(2),x=this._container.querySelector(".leaflet-proxy.leaflet-zoom-animated").style.transform;this._glZoomAnimation={startHalfSize:r,fixedCRSCoords:d,relativeContainerPoint:T,until:-1,bezier:L.glUtil.unitBezier(0,0,.25,1),transformCSS:x,scale:this.getZoomScale(this._animateToZoom,this._zoom)},this.on("glPrepareFrame",this._onGlZoomAnimationFrame),this.glRenderUntil(this._glZoomAnimationDuration)},_onGlZoomAnimationEnd:function(t){this._glZoomAnimation=null,this.off("glPrepareFrame",this._onGlZoomAnimationFrame)},_onGlZoomAnimationFrame:function(){var t=null;if(this._glZoomAnimation){if(-1===this._glZoomAnimation.until){var e=this._container.querySelector(".leaflet-proxy.leaflet-zoom-animated").style.transform;if(e===this._glZoomAnimation.transformCSS)return;this._glZoomAnimation.until=performance.now()+this._glZoomAnimationDuration,this.glRenderUntil(this._glZoomAnimationDuration)}var i=this._glZoomAnimation,r=Math.min(1-(i.until-performance.now())/this._glZoomAnimationDuration,1),n=i.bezier.solve(r),o=1+n*(i.scale-1);this._glView.halfSize=t=i.startHalfSize.divideBy(o);var a=new L.Point(t.x*i.relativeContainerPoint.x,t.y*i.relativeContainerPoint.y);this._glView.center=i.fixedCRSCoords.subtract(a)}}})}(),function(){var t=L.extend({},L.Map.prototype);L.Map.include({_initLayout:function(){t._initLayout.call(this);this.getSize();this._glCanvas=L.DomUtil.create("canvas","leaflet-webgl",this._container);var e=this._gl=this._glCanvas.getContext(L.Browser.gl,{premultipliedAlpha:!1});this._glPrograms=[],this._glLayers={},this._glView={},this._glResizeCanvas(),e.clearColor(.5,.5,.5,0),e.enable(e.BLEND),e.blendFunc(e.SRC_ALPHA,e.ONE_MINUS_SRC_ALPHA),e.pixelStorei(e.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0),e.enable(e.DEPTH_TEST)},registerGlProgram:function(t,e,i,r,n,o){if(!(t in this._glLayers)){this._glLayers[t]=[];var a=this._gl;if(!a)throw Error("A layer tried to register a WebGL program before the map initialized its layout and WebGL context.");var s="uniform vec2 uCenter,uHalfViewportSize;vec4 crs2clipspace(vec4 a){return vec4((a.x-uCenter.x)/uHalfViewportSize.x,(-a.y+uCenter.y)/uHalfViewportSize.y,a[2],a[3]);}\n",l=L.GlUtil.createProgram(a,s+i,r,n,["uCenter","uHalfViewportSize"].concat(o));l.priority=e,l.name=t;for(var h in l.attributes)a.enableVertexAttribArray(l.attributes[h]);this._glPrograms.push(l),this._glPrograms.sort(function(t,e){return t.priority-e.priority})}},attachLayerToGlProgram:function(t,e){if(!(e in this._glLayers))throw new Error("Layer tried to attach to a non-existing GL program");return this._glLayers[e].push(t),this},detachLayerFromGlProgram:function(t,e){if(!(e in this._glLayers))throw new Error("Layer tried to detach from a non-existing GL program");return this._glLayers[e].splice(this._glLayers[e].indexOf(t),1),this},getGlContext:function(){return this._gl},glRenderUntil:function(t){return this._glEndTime?this._glEndTime=Math.max(performance.now()+t,this._glEndTime):(this.fire("glRenderStart",{now:performance.now()}),this._glEndTime=performance.now()+t,L.Util.requestAnimFrame(this._glRender,this)),this},glRenderOnce:function(){return this._glEndTime||(this._glEndTime=1,L.Util.requestAnimFrame(this._glRender,this)),this},_glRender:function(){var t=performance.now();this._glEndTime&&this._glEndTime>t?L.Util.requestAnimFrame(this._glRender,this):(this._glEndTime=null,this.fire("glRenderEnd",{now:performance.now()}));var e=this._gl;e.viewport(0,0,e.drawingBufferWidth,e.drawingBufferHeight),e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT),this.fire("glPrepareFrame");var i,r=this._glView;for(var n in this._glPrograms){var o=this._glPrograms[n],a=o.name;if(this._glLayers[a].length){e.useProgram(o),e.uniform2f(o.uniforms.uCenter,r.center.x,r.center.y),e.uniform2f(o.uniforms.uHalfViewportSize,r.halfSize.x,r.halfSize.y);for(i in this._glLayers.tile)this._glLayers.tile[i].glRender(o)}}var s=performance.now(),l=s-t,h=1e3/(s-this._glLastFrameTimestamp);this.fire("glRenderFrame",{now:s,frameTime:l,fps:h}),this._glLastFrameTimestamp=s},invalidateSize:function(e){t.invalidateSize.call(this,e),this._glResizeCanvas(),this.glRenderOnce()},_glResizeCanvas:function(){var t=this.getSize();this._glCanvas.style.width=t.x+"px",this._glCanvas.style.height=t.y+"px",this._glCanvas.width=t.x,this._glCanvas.height=t.y,this._gl.viewportWidth=this._glCanvas.width,this._gl.viewportHeight=this._glCanvas.height}})}(),function(){var t=L.extend({},L.TileLayer.prototype);L.TileLayer.addInitHook(function(){this.options.crossOrigin=!0}),L.TileLayer.include({onAdd:function(e){t.onAdd.call(this,e),e.registerGlProgram("tile",1,"precision mediump float;attribute vec3 aCRSCoords;attribute vec2 aTextureCoords;varying vec2 a;attribute float aAge;varying float b;uniform float uTileZoom;void main(){gl_Position=crs2clipspace(vec4(aCRSCoords.x,aCRSCoords.y,0,1));gl_Position.z+=abs(aCRSCoords.z-uTileZoom)*1e-5;a=aTextureCoords;b=aAge;}","precision mediump float;varying vec2 a;varying float b;uniform sampler2D uTexture;uniform float uNow;void main(){lowp vec4 c=texture2D(uTexture,vec2(a.s,a.t));c.a*=clamp((uNow-b)/2e2,0.,1.);gl_FragColor=c;}",["aCRSCoords","aTextureCoords","aAge"],["uNow","uTexture","uTileZoom"]),e.attachLayerToGlProgram(this,"tile")},onRemove:function(e){t.onRemove.call(this,e),e.detachLayerFromGlProgram(this,"tile")},_initContainer:function(){},_tileReady:function(t,e,i){if(this._map){e&&this.fire("tileerror",{error:e,tile:i,coords:coords});var r=this._tileCoordsToKey(t);if(i=this._tiles[r]){i.glData=new Float32Array(24),i.age=performance.now();var n=this._tileCoordsToProjectedBounds(t),o=i.coords.z;i.glData.set([n.min.x,n.min.y,o,0,1,i.age,n.max.x,n.min.y,o,1,1,i.age,n.min.x,n.max.y,o,0,0,i.age,n.max.x,n.max.y,o,1,0,i.age]),i.texture=L.GlUtil.initTexture(this._map.getGlContext(),i.el),this.fire("tileload",{tile:i.el,coords:t}),this._noTilesToLoad()&&(this._loading=!1,this.fire("load")),this._map.glRenderUntil(500)}}},_tileCoordsToProjectedBounds:function(t){var e=this._map,i=e.options.crs,r=i.transformation,n=this._getTileSize(),o=i.scale(t.z),a=t.multiplyBy(n),s=a.add([n,n]);return a=r.untransform(a,o),s=r.untransform(s,o),new L.Bounds(a,s)},_removeTile:function(t){var e=this._tiles[t];e&&(window.setTimeout(function(){this._map.getGlContext().deleteTexture(e.texture),delete this._tiles[t]}.bind(this),500),this.fire("tileunload",{tile:e.el,coords:this._keyToTileCoords(t)}))},_invalidateGlVertexBuffer:function(){this.map.getGlContext().destroyBuffer(this._glVertexBuffer),this._glVertexBuffer=null},_getGlBuffers:function(){if(this._glBuffers)return this._glBuffers;var t=Object.keys(this._tiles).length,e=this._map.getGlContext(),i=24,r=new Float32Array(t*i),n=0,o=[];for(var a in this._tiles){var s=this._tiles[a];s.age&&(r.set(s.glData,n*i),o[n]=s.texture,n++)}return{vertices:L.GlUtil.initBuffer(e,r,e.DYNAMIC_DRAW),textures:o,length:n}},glRender:function(t,e){var i=this._map.getGlContext(),r=this._getGlBuffers();i.uniform1f(t.uniforms.uTileZoom,this._tileZoom),i.uniform1f(t.uniforms.uNow,performance.now());var n=t.attributes;i.bindBuffer(i.ARRAY_BUFFER,r.vertices),i.vertexAttribPointer(n.aCRSCoords,3,i.FLOAT,!1,24,0),i.vertexAttribPointer(n.aTextureCoords,2,i.FLOAT,!1,24,12),i.vertexAttribPointer(n.aAge,1,i.FLOAT,!1,24,20);for(var o=0;o<r.length;o++)i.activeTexture(i.TEXTURE0),i.bindTexture(i.TEXTURE_2D,r.textures[o]),i.uniform1i(t.uniforms.uTexture,0),i.drawArrays(i.TRIANGLE_STRIP,4*o,4)}})}());
//# sourceMappingURL=Leaflet.gl.min.js.map
